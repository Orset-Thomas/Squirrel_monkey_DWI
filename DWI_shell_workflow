                                    # Squirrel monkey 11.7T multishell diffusion wheighted image workflow


#Denoising all images
for_each DWI_*/ : dwidenoise IN/1.nii IN/1_denoised.nii

#Create Multishell
fslmerge -t Multishell *B300*/300_denoised_DWIs.nii *B1000*/1000_denoised_DWIs.nii *B2000*/2000_denoised_DWIs.nii

#Reorient Multishell to standard orientation (even if it already looks good)
fslreorient2std Multishell Multishell_2std

#create bval file
echo "0 300 300 300 300 300 300 300 0 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 0 0 0 0 0 0 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000">>bvals
#create bvec file
echo "0 -0.310942015 0.044995366 -0.962950891 0.279071172 0.59670381 0.767968514 -0.442851006 0 -0.928515934 -0.371203104 -0.045992136 0.311789146 -0.735157708 -0.754807926 -0.216082559 -0.678927698 -0.42205466 0.480703497 -0.93397525 -0.549229076 -0.272933822 0.043008065 -0.067985181 -0.954849623 -0.35988036 0.840587373 -0.392809534 -0.714972117 -0.688006536 0.427192921 0.153980908 -0.715209587 0.622030791 -0.060990151 -0.981789919 0.359824988 -0.021990348 0 0 0 0 0 0 -0.253892753 -0.277053892 0.88077323 0.669063229 0.821655798 -0.234121072 0.466980854 0.880167248 -0.356132328 0.130974986 -0.849686948 0.325891659 -0.453132787 -0.808795401 -0.053983025 -0.455817254 0.571786763 -0.998965037 -0.16310393 -0.536975568 0.600296319 -0.640250387 0.006001125 0.740877395 0.018997132 0.403012292 -0.928332403 0.707009191 0.197009949 0.474058787 -0.506666976 0.919885022 -0.10602179 0.149972932 0.927021322 0.060025666 -0.667926198 0.599980801 0.455160017 0.661855731 0.351114131 0.673332035 0.768762489 0.308142395 -0.257044987 -0.925160067 -0.944022185 -0.654839911 -0.236066108 0.146024461 0.279949614 0.064973172 0.2499083 -0.516842387 0.787753865 -0.973954712 0.059992891 -0.360895175 0.663759762 -0.295919373 -0.801011615 0.810260135 -0.800028001 0.628032659">>bvecs
echo "0 -0.935825485 -0.254973739 0.266986384 -0.520132651 0.60969736 0.066997253 0.869707393 0 -0.008004448 -0.009004927 0.998829215 0.596596539 -0.555119086 0.627840235 0.584223216 -0.695925888 0.571073959 -0.087945754 0.030999179 0.758316284 -0.815802192 -0.876164296 -0.165963824 -0.296953234 -0.452849453 -0.425790988 -0.919554124 0.221991343 -0.269002556 -0.888401204 -0.865892636 -0.235068885 -0.381018861 0.54091265 0.189959353 0.841590666 -0.262884619 0 0 0 0 0 0 -0.714698104 0.699135995 0.204947233 -0.705066632 0.076967757 -0.037019144 0.87196425 -0.414078682 0.536199235 -0.985811728 -0.505813642 -0.141952809 -0.549160928 0.274930451 0.926708596 -0.324869753 -0.750720034 -0.03799867 -0.821523477 -0.780964467 0.047023212 0.343134192 0.367068832 0.588902545 0.445932669 -0.803024493 0.340121785 0.459005967 0.977049342 -0.88010914 0.264825934 -0.132983378 -0.048009867 -0.889839398 0.351008073 -0.712304575 -0.345961773 -0.007999744 0.776272908 -0.543881447 -0.455147947 0.73736361 -0.635803567 0.324149792 -0.88015404 -0.235040666 0.076001786 0.557863619 -0.488136697 0.957160338 -0.941830486 0.659727589 -0.2529072 -0.599817084 -0.014995315 0.203990515 -0.218974053 0.885742729 0.241912444 0.726801973 -0.589008541 -0.513164752 0.283009906 0.566029434">>bvecs
echo "0 -0.16596905 0.965900517 0.037998062 -0.807205864 -0.52174102 0.636973885 -0.21792668 0 -0.371206262 0.928508033 -0.014997436 0.739499897 0.389083467 0.189951663 -0.782298895 -0.233975083 0.704091186 0.872461857 0.355990566 -0.351146459 0.50987637 -0.480090025 -0.983785558 -0.008998583 0.815728815 0.334835636 0.010994669 0.662974145 -0.674006403 -0.168075903 0.475940987 0.658192879 0.684033861 0.838864534 0.001999572 0.402804083 0.964576644 0 0 0 0 0 0 0.651724704 0.659128213 0.42689009 0.235022211 -0.564763414 -0.971502397 0.146993973 -0.232044093 -0.765284356 -0.104979951 0.148945124 -0.934689267 -0.702205776 -0.51986849 -0.371883061 0.828667771 -0.330876606 0.024999125 -0.546348135 0.318985486 0.798394105 0.687268775 -0.930174424 0.322946557 0.894864886 0.43901339 -0.150053729 -0.538006994 -0.081004091 -0.026003225 -0.820460724 -0.368953884 0.993204124 -0.430922226 0.132003036 0.699299014 -0.658927193 -0.799974401 0.436153335 0.515887549 -0.81826598 -0.054026642 -0.068978689 0.894413314 0.399069843 0.298051567 -0.321007544 0.509875351 0.840235299 0.250041886 0.185966529 0.748690855 0.934657044 0.61081373 0.61580759 0.098995397 -0.973884602 0.291915211 -0.707743843 -0.619831119 -0.107001552 0.283090887 0.529018516 0.53402777">>bvecs
#Create acqparams file
echo "-1 0 0 0.051">>acqparams.txt
echo "1 0 0 0.051">>acqparams.txt
indx=""
for ((i=1; i<=108; i+=1)); do indx="$indx 1"; done
echo $indx > index.txt


#Tilt correction
#use a manualy created matrix (fsleyes/nudge)
flirt -interp trilinear -in Multishell_2std -ref Multishell_2std -applyxfm -init *_reorient_matrix.mat -out Multishell_reoriented


#Create brain mask 
BrainSuite21a
#save mask as "Multishell_reoriented_mask.nii"

#EDDY
eddy --imain=Multishell_reoriented.nii.gz --mask=Multishell_reoriented_mask --acqp=acqparams.txt --index=index.txt --bvecs=bvecs --bvals=bvals --data_is_shelled --out=eddy_corrected_data
cp bvals eddy_corrected_data.bval
cp eddy_corrected_data.eddy_rotated_bvecs eddy_corrected_data.bvec


#DTIFIT
#dtifit --data=eddy_corrected_data.nii --out=DTIFIT --mask=Multishell_reoriented_mask.nii --bvecs=eddy_corrected_data.bvec --bvals=eddy_corrected_data.bval

gunzip eddy_corrected_data.nii.gz

#NODDI 
python NoddiThis.py eddy_corrected_data eddy_corrected_data.bval eddy_corrected_data.bvec eddy_corrected_data.nii Multishell_reoriented_mask.nii
#dir = principal diection
#IsoVF represents the CSF water fraction
#ICVF corres√¥nds to the intracellular volume fraction (surrogate for neuronal density)
#OD orientation dispersion as a surrogate for neurite dispersion /synaptic complexity)

#ActiveAx
python AxcalThis.py eddy_corrected_data eddy_corrected_data.bval eddy_corrected_data.bvec eddy_corrected_data.nii Multishell_reoriented_mask.nii
#FIT_a = Mean axonal diameter
#FIT_d = Axonal density
#FIT_v = Intra-cellular volume fraction
#FIT_dir

